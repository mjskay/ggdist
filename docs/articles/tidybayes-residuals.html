<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extracting and visualizing tidy residuals from Bayesian models • tidybayes</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Extracting and visualizing tidy residuals from Bayesian models">
<meta property="og:description" content="tidybayes">
<meta property="og:image" content="http://mjskay.github.io/tidybayes/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93322-5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93322-5');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidybayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tidybayes.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/freq-uncertainty-vis.html">Frequentist uncertainty visualization</a>
    </li>
    <li>
      <a href="../articles/slabinterval.html">Slab + interval stats and geoms</a>
    </li>
    <li>
      <a href="../articles/tidy-brms.html">Extracting and visualizing tidy draws from brms models</a>
    </li>
    <li>
      <a href="../articles/tidy-rstanarm.html">Extracting and visualizing tidy draws from rstanarm models</a>
    </li>
    <li>
      <a href="../articles/tidybayes-residuals.html">Extracting and visualizing tidy residuals from Bayesian models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mjskay/tidybayes/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extracting and visualizing tidy residuals from Bayesian models</h1>
                        <h4 class="author">Matthew Kay</h4>
            
            <h4 class="date">2020-04-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mjskay/tidybayes/blob/master/vignettes/tidybayes-residuals.Rmd"><code>vignettes/tidybayes-residuals.Rmd</code></a></small>
      <div class="hidden name"><code>tidybayes-residuals.Rmd</code></div>

    </div>

    
    
<style type="text/css">
.kable-table table {
  margin-left: 0;
}
img {
  border: none;
}
</style>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette describes how to use the <code>tidybayes</code> package to extract <a href="http://dx.doi.org/10.18637/jss.v059.i10">tidy</a> data frames of draws from residuals of Bayesian models, and also acts as a demo for the construction of randomized quantile residuals, a generic form of residual applicable to a wide range of models, including censored regressions and models with discrete response variables. For a more general introduction to <code>tidybayes</code>, see <code><a href="tidybayes.html">vignette(“tidybayes”)</a></code>.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>The following libraries are required to run this vignette:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r">library(dplyr)
library(purrr)
library(tidyr)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(brms)
library(gganimate)

theme_set(theme_tidybayes() + panel_border())</pre></body></html></div>
<p>These options help Stan run faster:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r">rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())</pre></body></html></div>
</div>
<div id="example-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#example-dataset" class="anchor"></a>Example dataset</h2>
<p>We’re going to use a simple dataset to demonstrate residuals that can be applied to discrete and censored outcomes. We’ll generate data from a Normal distribution:</p>
<p><span class="math display">\[
\begin{align*}
y^*_i &amp;\sim \textrm{Normal}(0.5,1) \\
y^\textrm{lower}_i &amp;= \lfloor{y^*_i}\rfloor \\
y^\textrm{upper}_i &amp;= \lceil{y^*_i}\rceil
\end{align*}
\]</span> Or we can write the vectorized version of the model:</p>
<p><span class="math display">\[
\begin{align*}
\mathbf{y}^* &amp;\sim \textrm{Normal}(0.5,1) \\
\mathbf{y}^\textrm{lower} &amp;= \lfloor{\mathbf{y}^*}\rfloor \\
\mathbf{y}^\textrm{upper} &amp;= \lceil{\mathbf{y}^*}\rceil
\end{align*}
\]</span></p>
<p>We don’t observe each <span class="math inline">\(y^*_i\)</span>, only <span class="math inline">\(y^\textrm{lower}_i\)</span> and <span class="math inline">\(y^\textrm{upper}_i\)</span>, i.e., the upper and lower bounds of an interval in which <span class="math inline">\(y^*_i\)</span> lies. This is <em>interval-censored</em> data.</p>
<p>We can generate it as follows:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">set.seed(4118)
n = 100

cens_df =
  tibble(
    y_star = rnorm(n, 0.5, 1),
    y_lower = floor(y_star),
    y_upper = ceiling(y_star),
    censoring = "interval"
  )</pre></body></html></div>
<p>A snapshot of the data looks like this:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">cens_df</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 x 4
##     y_star y_lower y_upper censoring
##      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
##  1  0.180        0       1 interval 
##  2  1.05         1       2 interval 
##  3  2.05         2       3 interval 
##  4 -0.512       -1       0 interval 
##  5  0.0323       0       1 interval 
##  6  1.18         1       2 interval 
##  7 -0.707       -1       0 interval 
##  8  0.116        0       1 interval 
##  9  0.183        0       1 interval 
## 10  0.385        0       1 interval</code></pre>
<p>This is a typical tidy format data frame: one observation per row.</p>
<p>A graphical depiction of the censoring process might be something like this:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">uncensored_plot = cens_df %&gt;%
  ggplot(aes(y = "", x = y_star)) +
  stat_slabh() +
  geom_jitter(aes(y = 0.75, color = ordered(y_lower)), position = position_jitter(height = 0.2), show.legend = FALSE) +
  ylab(NULL) +
  scale_x_continuous(breaks = -4:4, limits = c(-4, 4)) +
  background_grid("x")

censored_plot = cens_df %&gt;%
  ggplot(aes(y = "", x = (y_lower + y_upper)/2)) +
  geom_dotplot(
    aes(fill = ordered(y_lower)),
    method = "histodot", origin = -4, binwidth = 1, dotsize = 0.5, stackratio = .8, show.legend = FALSE,
    stackgroups = TRUE, binpositions = "all", color = NA
  ) +
  geom_segment(
    aes(x = y + 0.5, xend = y + 0.5, y = 1.75, yend = 1.5, color = ordered(y)),
    data = data.frame(y = unique(cens_df$y_lower)), show.legend = FALSE,
    arrow = arrow(type = "closed", length = unit(7, "points")), size = 1
  ) +
  ylab(NULL) +
  xlab("interval-censored y") +
  scale_x_continuous(breaks = -4:4, limits = c(-4, 4)) +
  background_grid("x")

plot_grid(align = "v", ncol = 1, rel_heights = c(1, 2.5),
  uncensored_plot,
  censored_plot
)</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-4-1.png" width="180"></p>
</div>
<div id="model-for-y_star" class="section level2">
<h2 class="hasAnchor">
<a href="#model-for-y_star" class="anchor"></a>Model for <code>y_star</code>
</h2>
<p>Before we fit a model to the censored data, let’s see what an ideal model looks like: we’ll fit a model to <code>y_star</code>. With censored or discrete data in the real-world, we would not be able to fit such a model, because we would not have observations of <code>y_star</code>, only the intervals. But this might help us understand what we’re looking for in a fit that’s working.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">m_ideal = brm(
  y_star ~ 1, 
  data = cens_df, 
  family = student,
  
  file = "models/tidybayes-residuals_m_ideal.rds"  # cache model (can be removed)
)</pre></body></html></div>
<p>This looks like this:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">m_ideal</span></pre></body></html></div>
<pre><code>##  Family: student 
##   Links: mu = identity; sigma = identity; nu = identity 
## Formula: y_star ~ 1 
##    Data: cens_df (Number of observations: 100) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.52      0.11     0.31     0.72 1.00     3186     2972
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     1.02      0.09     0.84     1.21 1.00     2523     2526
## nu       21.03     13.39     5.05    55.87 1.00     2365     2493
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div id="residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#residuals" class="anchor"></a>Residuals</h3>
<p><code><a href="../reference/add_predicted_draws.html">add_residual_draws()</a></code> operates much like <code><a href="../reference/add_predicted_draws.html">add_fitted_draws()</a></code> and <code><a href="../reference/add_predicted_draws.html">add_predicted_draws()</a></code>: it gives us draws from the posterior distribution for each residual:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r">cens_df %&gt;%
  add_residual_draws(m_ideal) %&gt;%
  ggplot(aes(x = .row, y = .residual)) +
  stat_pointinterval()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-6-1.png" width="648"></p>
<p>This is a typical residual plot, though with the addition of the uncertainty associated with each residual afforded by generating draws from the distribution associated with each residual.</p>
<p>Let’s check the QQ plot:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r">cens_df %&gt;%
  add_residual_draws(m_ideal) %&gt;%
  median_qi() %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<pre><code>## Warning: `combine()` is deprecated as of dplyr 1.0.0.
## Please use `vctrs::vec_c()` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-7-1.png" width="648"></p>
<p>This is a typical way of looking at residuals. However, this type of residual will not generalize to discrete and censored models, so let’s consider something else…</p>
</div>
<div id="probability-residuals-and-quantile-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#probability-residuals-and-quantile-residuals" class="anchor"></a>Probability residuals and quantile residuals</h3>
<p>To derive a more general form of residual, we will use the posterior predictive distribution, <span class="math inline">\(\mathbf{y}^{*\textrm{rep}}|\mathbf{y}^*\)</span>. This gives us the model’s predictive distribution for a replication of <span class="math inline">\(\mathbf{y}^*\)</span>, denoted <span class="math inline">\(\mathbf{y}^{*\textrm{rep}}\)</span>. In particular, for each observation, we will calculate the predicted probability of seeing an observation less than or equal to the observation we actually got:</p>
<p><span class="math display">\[
p^{*\textrm{resid}}_i = P(y^{*\textrm{rep}}_i \le y^*_i|\mathbf{y}^*)
\]</span> This is one type of Bayesian <strong>posterior predictive p-value</strong>; I will call it a <strong>probability residual</strong> (<code>p_residual</code>) by analogy to quantile residuals. If the predictive distribution is well-calibrated, these probabilities should be uniform (in general these will not be quite uniform due to the double use of <span class="math inline">\(\mathbf{y}*\)</span>; a future iteration of this article will demonstrate the use of leave-one-out posterior predictive distributions to address that issue).</p>
<p>If we apply the inverse cumulative distribution function (CDF) of the standard Normal distribution to these probability residuals, the result should be approximately standard Normal. These are <strong>quantile residuals</strong> (<code>z_residual</code>):</p>
<p><span class="math display">\[
z^{*\textrm{resid}}_i = F_{\textrm{Normal}}^{-1}(p^{*\textrm{resid}}_i)
\]</span></p>
<div class="sourceCode" id="cb13"><html><body><pre class="r">cens_df %&gt;%
  add_predicted_draws(m_ideal) %&gt;%
  summarise(
    p_residual = mean(.prediction &lt; y_star),
    z_residual = qnorm(p_residual)
  ) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-8-1.png" width="648"></p>
<p>This QQ plot shows us the model fits okay.</p>
</div>
</div>
<div id="basic-interval-censored-model" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-interval-censored-model" class="anchor"></a>Basic interval-censored model</h2>
<p>Assuming a situation where we do not have access to the original (uncensored) data, we will perform a regression on the interval-censored data. In brms, we can do this by specifying the lower (<code>y_lower</code>) and upper (<code>y_upper</code>) bounds on each observation, and the censoring type (<code>censoring</code>), which in this case is <code>"interval"</code> for all observations.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r">m = brm(
  y_lower | cens(censoring, y_upper) ~ 1, 
  data = cens_df,
  
  file = "models/tidybayes-residuals_m.rds"  # cache model (can be removed)
)</pre></body></html></div>
<p>The results look like this:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">m</span></pre></body></html></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: y_lower | cens(censoring, y_upper) ~ 1 
##    Data: cens_df (Number of observations: 100) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.56      0.11     0.33     0.77 1.00     2922     2353
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     1.09      0.08     0.94     1.27 1.00     3205     2561
## 
## Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Again, <code><a href="../reference/add_predicted_draws.html">add_residual_draws()</a></code> lets us look at the residuals:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r">cens_df %&gt;%
  add_residual_draws(m) %&gt;%
  ggplot(aes(x = .row, y = .residual)) +
  stat_pointinterval()</pre></body></html></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-10-1.png" width="648"></p>
<p>But notice the horizontal striations due to censoring. This obscures patterns we might wish to see in the diagnostic plots. Patterns like this often show up in censored regression, logistic regression, Poisson regression, and other discrete regression models. Notice how <code>brms</code> also gives us a warning message that the residuals may not be meaningful due to censoring.</p>
<p>Let’s look at the QQ plot:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r">cens_df %&gt;%
  add_residual_draws(m) %&gt;%
  median_qi(.residual) %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-11-1.png" width="648"></p>
<p>Again, the striations are making interpretation difficult. But there is hope!</p>
<div id="randomized-quantile-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals" class="anchor"></a>Randomized quantile residuals</h3>
<p>We can extend the ideas of <strong>probability residuals</strong> to make <strong>randomized probability residuals</strong>.</p>
<p>Where the probability residual for the uncensored model was something like this:</p>
<p><span class="math display">\[
p^{*\textrm{resid}}_i = P(y^{*\textrm{rep}}_i &lt; y^*_i|\mathbf{y}^*)
\]</span> We can’t calculate the residual for a censored observation this way, as we do not know what <span class="math inline">\(\mathbf{y}^*\)</span> is, only <span class="math inline">\(\mathbf{y}^\textrm{lower}\)</span> and <span class="math inline">\(\mathbf{y}^\textrm{upper}\)</span>. However, we do know that <span class="math inline">\(p^{*\textrm{resid}}_i\)</span> should be in the following interval:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; p^{*\textrm{resid}}_i &amp;\in (p^\textrm{lower}_i, p^\textrm{upper}_i] \\
&amp;\textrm{where}&amp; p^\textrm{lower}_i &amp;= P(y^{*\textrm{rep}}_i &lt; y^\textrm{lower}_i|\mathbf{y}^\textrm{lower},\mathbf{y}^\textrm{upper}) \\
&amp;&amp;      p^\textrm{upper}_i &amp;= P(y^{*\textrm{rep}}_i \le y^\textrm{upper}_i|\mathbf{y}^\textrm{lower},\mathbf{y}^\textrm{upper})
\end{align*}
\]</span></p>
<p>If we define a <strong>randomized probability residual</strong> as:</p>
<p><span class="math display">\[
p^{\textrm{resid}}_i \sim \textrm{Uniform}(p^\textrm{lower}_i, p^\textrm{upper}_i)
\]</span></p>
<p>Then these residuals will be uniformly random (see <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.362.9960&amp;rep=rep1&amp;type=pdf">Dunn and Smyth 1996</a>), and we can similarly define a <strong>randomized quantile residual</strong> by passing the probability residuals through the Normal inverse CDF:</p>
<p><span class="math display">\[
z^{\textrm{resid}}_i = F_{\textrm{Normal}}^{-1}(p^{\textrm{resid}}_i)
\]</span></p>
<p>In code, that looks like this:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r">cens_df %&gt;%
  add_predicted_draws(m) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_lower),
    p_upper = mean(.prediction &lt; y_upper),
    p_residual = runif(1, p_lower, p_upper),
    z_residual = qnorm(p_residual)
  ) %&gt;%
  ggplot(aes(x = .row, y = z_residual)) +
  geom_point()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-12-1.png" width="648"></p>
<p>The striations are gone! And a QQ plot:</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r">cens_df %&gt;%
  add_predicted_draws(m) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_lower),
    p_upper = mean(.prediction &lt; y_upper),
    p_residual = runif(1, p_lower, p_upper),
    z_residual = qnorm(p_residual)
  ) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-13-1.png" width="648"></p>
<p>Looks decent. However, our residuals are now subject to noise—we actually have a distribution of possible QQ plots. So, let’s check on some of them to make sure this nice-looking one is not just a fluke. We’ll employ <a href="https://mucollective.co/project/hops-trends">HOPs</a> to do that:</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r">k = 20

p = cens_df %&gt;%
  add_predicted_draws(m) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_lower),
    p_upper = mean(.prediction &lt; y_upper),
    p_residual = list(runif(k, p_lower, p_upper)),
    residual_draw = list(1:k)
  ) %&gt;%
  unnest(c(p_residual, residual_draw)) %&gt;%
  mutate(z_residual = qnorm(p_residual)) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline() +
  transition_manual(residual_draw)

animate(p, nframes = k, width = 384, height = 384, res = 96, dev = "png", type = "cairo")</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-14-1.gif"><!-- --></p>
<p>Looks good.</p>
</div>
</div>
<div id="what-if-the-model-does-not-fit-well" class="section level2">
<h2 class="hasAnchor">
<a href="#what-if-the-model-does-not-fit-well" class="anchor"></a>What if the model does not fit well?</h2>
<p>Let’s instead generate the data from a t distribution, which should give us some more extreme values:</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r">set.seed(41181)
n = 100

cens_df_t =
  tibble(
    y = rt(n, 3) + 0.5,
    y_lower = floor(y),
    y_upper = ceiling(y),
    censoring = "interval"
  )</pre></body></html></div>
<p>Note the presence of outliers:</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r">uncensored_plot = cens_df_t %&gt;%
  ggplot(aes(y = "", x = y)) +
  stat_slabh() +
  geom_jitter(aes(y = 0.75, color = ordered(y_lower)), position = position_jitter(height = 0.2), show.legend = FALSE) +
  ylab(NULL) +
  scale_x_continuous(breaks = -10:10, limits = c(-10, 10)) +
  background_grid("x")

censored_plot = cens_df_t %&gt;%
  ggplot(aes(y = "", x = (y_lower + y_upper)/2)) +
  geom_dotplot(
    aes(fill = ordered(y_lower)),
    method = "histodot", origin = -4, binwidth = 1, dotsize = 0.5, stackratio = .8, show.legend = FALSE,
    stackgroups = TRUE, binpositions = "all", color = NA
  ) +
  geom_segment(
    aes(x = y + 0.5, xend = y + 0.5, y = 1.75, yend = 1.5, color = ordered(y)),
    data = data.frame(y = unique(cens_df_t$y_lower)), show.legend = FALSE,
    arrow = arrow(type = "closed", length = unit(7, "points")), size = 1
  ) +
  ylab(NULL) +
  xlab("interval-censored y") +
  scale_x_continuous(breaks = -10:10, limits = c(-10, 10)) +
  background_grid("x")

plot_grid(align = "v", ncol = 1, rel_heights = c(1, 2.25),
  uncensored_plot,
  censored_plot
)</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-16-1.png" width="432"></p>
<div id="model" class="section level3">
<h3 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h3>
<p>Now, fitting the same model as before:</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r">m_t1 = brm(
  y_lower | cens(censoring, y_upper) ~ 1,
  data = cens_df_t,

  file = "models/tidybayes-residuals_m_t1"  # cache model (can be removed)
)</pre></body></html></div>
<p>And checking the QQ plot:</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r">cens_df_t %&gt;%
  add_residual_draws(m_t1) %&gt;%
  median_qi(.residual) %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-17-1.png" width="648"></p>
<p>It looks like this could be problematic, but the striations make diagnosing the problem difficult.</p>
</div>
<div id="randomized-quantile-residuals-1" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-1" class="anchor"></a>Randomized quantile residuals</h3>
<p>Let’s try randomized quantile residuals again:</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r">cens_df_t %&gt;%
  add_predicted_draws(m_t1) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_lower),
    p_upper = mean(.prediction &lt; y_upper),
    p_residual = runif(1, p_lower, p_upper),
    z_residual = qnorm(p_residual)
  ) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline()</pre></body></html></div>
<pre><code>## Warning: Removed 1 rows containing non-finite values (stat_qq).</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-18-1.png" width="648"></p>
<p>Does not look good for the model—this s-shape is characteristic of excess kurtosis (aka fat tails), which is exactly what a t distribution should produce. So let’s try a different model.</p>
</div>
</div>
<div id="robust-interval-censored-model" class="section level2">
<h2 class="hasAnchor">
<a href="#robust-interval-censored-model" class="anchor"></a>Robust interval-censored model</h2>
<p>A common model to try to “robustify” linear regression is to swap out the Normal response distribution for a Student’s t distribution, which has fatter tails (it also happens that this is the distribution used to generate the data above, so I am clearly cheating, but also: <em>this had better work</em>).</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r">m_t2 = brm(
  y_lower | cens(censoring, y_upper) ~ 1, 
  data = cens_df_t,
  family = student,
  
  file = "models/tidybayes-residuals_m_t2.rds"  # cache model (can be removed)
)</pre></body></html></div>
<p>Let’s look at the QQ plot of the residuals:</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r">cens_df_t %&gt;%
  add_residual_draws(m_t2) %&gt;%
  median_qi(.residual) %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-19-1.png" width="648"></p>
<p>Odd, these don’t look great! But again, these residuals are not to be trusted…</p>
<div id="randomized-quantile-residuals-2" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-2" class="anchor"></a>Randomized quantile residuals</h3>
<p>Let’s check out the randomized quantile residuals:</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r">k = 20

p = cens_df_t %&gt;%
  add_predicted_draws(m_t2) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_lower),
    p_upper = mean(.prediction &lt; y_upper),
    p_residual = list(runif(k, p_lower, p_upper)),
    residual_draw = list(1:k)
  ) %&gt;%
  unnest(c(p_residual, residual_draw)) %&gt;%
  mutate(z_residual = qnorm(p_residual)) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline() +
  transition_manual(residual_draw)

animate(p, nframes = k, width = 384, height = 384, res = 96, dev = "png", type = "cairo")</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-20-1.gif"><!-- --></p>
<p>Looking pretty good! As well they should, since this is the same model that generated the data.</p>
</div>
</div>
<div id="ordinal-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#ordinal-regression" class="anchor"></a>Ordinal regression</h2>
<p>But we’re not done yet—another sensible choice of model for this data might have been an ordinal regression. So let’s try that too.</p>
<p>First, we’ll add a column that transforms the data into an ordered factor:</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r">cens_df_o = cens_df_t %&gt;%
  mutate(y_factor = ordered(y_lower))</pre></body></html></div>
<p>Then we’ll fit an ordinal regression model. We have to adjust the fit parameters a bit to get it to converge:</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r">m_o = brm(
  y_factor ~ 1, 
  data = cens_df_o, 
  family = cumulative, 
  prior = prior(normal(0, 10), class = Intercept), 
  control = list(adapt_delta = 0.99),
  
  file = "models/tidybayes-residuals_m_o.rds"  # cache model (can be removed)
)</pre></body></html></div>
<p>Now, let’s check out those residuals:</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r">cens_df_o %&gt;%
  add_residual_draws(m_o) %&gt;%
  median_qi(.residual) %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<pre><code>## Error: Predictive errors are not defined for ordinal or categorical models.</code></pre>
<p>Gah! <code>brms</code> will not even produce residuals for models like these. This is very sensible, as standard residuals here are hard to define. Fortunately, we can still construct randomized quantile residuals.</p>
<div id="randomized-quantile-residuals-for-a-discrete-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-for-a-discrete-distribution" class="anchor"></a>Randomized quantile residuals for a discrete distribution</h3>
<p>For the interval-censored model, we had:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; p^\textrm{lower}_i &amp;= P(y^{*\textrm{rep}}_i &lt; y^\textrm{lower}_i|\mathbf{y}^\textrm{lower},\mathbf{y}^\textrm{upper}) \\
&amp;&amp;      p^\textrm{upper}_i &amp;= P(y^{*\textrm{rep}}_i \le y^\textrm{upper}_i|\mathbf{y}^\textrm{lower},\mathbf{y}^\textrm{upper}) \\
&amp;&amp; p^{\textrm{resid}}_i &amp;\sim \textrm{Uniform}(p^\textrm{lower}_i, p^\textrm{upper}_i)
\end{align*}
\]</span></p>
<p>But that was for a model with observations of the form <span class="math inline">\((\mathbf{y}^\textrm{lower}, \mathbf{y}^\textrm{upper}]\)</span> and which can produce a posterior predictive distribution for the latent variable <span class="math inline">\(\mathbf{y}^{*\textrm{rep}}|\mathbf{y}^\textrm{lower}, \mathbf{y}^\textrm{upper}\)</span>. Now our observations are discrete values of <span class="math inline">\(\mathbf{y}^\textrm{factor}\)</span>, and our posterior predictive distribution, <span class="math inline">\(\mathbf{y}^\textrm{rep}|\mathbf{y}^\textrm{factor}\)</span>, is also discrete. So we have to tweak the definition a bit:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; p^\textrm{lower}_i &amp;= P(y^{\textrm{rep}}_i &lt; y^\textrm{factor}_i|\mathbf{y}^\textrm{factor}) \\
&amp;&amp;      p^\textrm{upper}_i &amp;= P(y^{\textrm{rep}}_i \le y^\textrm{factor}_i|\mathbf{y}^\textrm{factor}) \\
&amp;&amp; p^{\textrm{resid}}_i &amp;\sim \textrm{Uniform}(p^\textrm{lower}_i, p^\textrm{upper}_i)
\end{align*}
\]</span></p>
<p>Then we proceed as before:</p>
<div class="sourceCode" id="cb39"><html><body><pre class="r">cens_df_o %&gt;%
  add_predicted_draws(m_o) %&gt;%
  mutate(.prediction = ordered(levels(y_factor)[.prediction], levels = levels(y_factor))) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_factor),
    p_upper = mean(.prediction &lt;= y_factor),
    p_residual = runif(1, p_lower, p_upper),
    z_residual = qnorm(p_residual)
  ) %&gt;%
  ggplot(aes(x = .row, y = z_residual)) +
  geom_point()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-23-1.png" width="648"></p>
<p>Or in HOPs-QQ plot form:</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r">k = 20

p = cens_df_o %&gt;%
  add_predicted_draws(m_o) %&gt;%
  mutate(.prediction = ordered(levels(y_factor)[.prediction], levels = levels(y_factor))) %&gt;%
  summarise(
    p_lower = mean(.prediction &lt; y_factor),
    p_upper = mean(.prediction &lt;= y_factor),
    p_residual = list(runif(k, p_lower, p_upper)),
    residual_draw = list(1:k)
  ) %&gt;%
  unnest(c(p_residual, residual_draw)) %&gt;%
  mutate(z_residual = qnorm(p_residual)) %&gt;%
  ggplot(aes(sample = z_residual)) +
  geom_qq() +
  geom_abline() +
  transition_manual(residual_draw)

animate(p, nframes = k, width = 384, height = 384, res = 96, dev = "png", type = "cairo")</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-24-1.gif"><!-- --></p>
<p>It is not too surprising that the ordinal regression also works here, even though it is not the data generating model. Ordinal regressions are pretty robust.</p>
</div>
</div>
<div id="a-function-for-probability-residuals" class="section level2">
<h2 class="hasAnchor">
<a href="#a-function-for-probability-residuals" class="anchor"></a>A function for probability residuals</h2>
<p>Here’s a function that can calculate randomized probability residuals for you. A future version of <code>tidybayes</code> will likely supply some variant of this function, but for now, since it is experimental, I have not folded it into the main package yet. Use at your own risk:</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r">library(rlang)
make_probability_residuals = function(data, prediction, y, y_upper = NA, n = 1) {
  .prediction = enquo(prediction)
  .y = enquo(y)
  .y_upper = enquo(y_upper)

  if (eval_tidy(expr(is.factor(!!.prediction) &amp;&amp; !is.ordered(!!.prediction)), data)) {
    data = mutate(data, !!.prediction := ordered(!!.prediction, levels = levels(!!.prediction)))
  }
  
  if (is.na(enquo(y_upper)[[2]])) {
    #no y_upper provided, use y as y_upper
    data = summarise(data,
      .p_lower = mean(!!.prediction &lt; !!.y),
      .p_upper = mean(!!.prediction &lt;= !!.y)
    )
  } else {
    #y_upper should be a vector, and if an entry in it is NA, use the entry from y
    data = summarise(data,
      .p_lower = mean(!!.prediction &lt; !!.y),
      .p_upper = mean(!!.prediction &lt;= ifelse(is.na(!!.y_upper), !!.y, !!.y_upper))
    )
  }
  
  data %&gt;%
    mutate(
      .p_residual = map2(.p_lower, .p_upper, runif, n = !!n),
      .residual_draw = map(.p_residual, seq_along)
    ) %&gt;%
    unnest(c(.p_residual, .residual_draw)) %&gt;%
    mutate(.z_residual = qnorm(.p_residual))
}</pre></body></html></div>
</div>
<div id="logistic-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#logistic-regression" class="anchor"></a>Logistic regression</h2>
<p>Consider a simple dataset with a single binary outcome:</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r">set.seed(51919)

bin_df = tibble(
  y = rbernoulli(100, .7)
)</pre></body></html></div>
<p>A model for this might be the following:</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r">m_bin = brm(
  y ~ 1, 
  data = bin_df, 
  family = bernoulli,
  
  file = "models/tidybayes-residuals_m_bin.rds"  # cache model (can be removed)
)</pre></body></html></div>
<p>Again, standard residuals are hard to interpret:</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r">bin_df %&gt;%
  add_residual_draws(m_bin) %&gt;%
  median_qi() %&gt;%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-27-1.png" width="648"></p>
<p>Randomized quantile residuals help us see that the fit is probably reasonable. In this case (just to switch it up), we’ll look at the probability residuals instead, comparing them against a uniform distribution, like so:</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r">k = 20

p = bin_df %&gt;%
  add_predicted_draws(m_bin) %&gt;%
  make_probability_residuals(.prediction, y, n = k) %&gt;%
  ggplot(aes(sample = .p_residual)) +
  geom_qq(distribution = qunif) +
  geom_abline() +
  transition_manual(.residual_draw)</pre></body></html></div>
<pre><code>## Warning: Subsetting quosures with `[[` is deprecated as of rlang 0.4.0
## Please use `quo_get_expr()` instead.
## This warning is displayed once per session.</code></pre>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="fu">animate</span>(<span class="no">p</span>, <span class="kw">nframes</span> <span class="kw">=</span> <span class="no">k</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">384</span>, <span class="kw">height</span> <span class="kw">=</span> <span class="fl">384</span>, <span class="kw">res</span> <span class="kw">=</span> <span class="fl">96</span>, <span class="kw">dev</span> <span class="kw">=</span> <span class="st">"png"</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"cairo"</span>)</pre></body></html></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-28-1.gif"><!-- --></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://www.mjskay.com">Matthew Kay</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
